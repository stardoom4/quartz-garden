{"version":3,"file":"worker.js","sources":["../src/transfer.js","../src/worker.js"],"sourcesContent":["/**\n * The helper class for transferring data from the worker to the main thread.\n *\n * @param {Object} message The object to deliver to the main thread.\n * @param {Object[]} transfer An array of transferable Objects to transfer ownership of.\n */\nfunction Transfer(message, transfer) {\n  this.message = message;\n  this.transfer = transfer;\n}\n\nmodule.exports = Transfer;\n","/**\n * worker must be started as a child process or a web worker.\n * It listens for RPC messages from the parent process.\n */\nvar Transfer = require('./transfer');\n\n/**\n * Special message sent by parent which causes the worker to terminate itself.\n * Not a \"message object\"; this string is the entire message.\n */\nvar TERMINATE_METHOD_ID = '__workerpool-terminate__';\n\n// var nodeOSPlatform = require('./environment').nodeOSPlatform;\n\n// create a worker API for sending and receiving messages which works both on\n// node.js and in the browser\nvar worker = {\n  exit: function() {}\n};\nif (typeof self !== 'undefined' && typeof postMessage === 'function' && typeof addEventListener === 'function') {\n  // worker in the browser\n  worker.on = function (event, callback) {\n    addEventListener(event, function (message) {\n      callback(message.data);\n    })\n  };\n  worker.send = function (message) {\n    postMessage(message);\n  };\n}\nelse if (typeof process !== 'undefined') {\n  // node.js\n\n  var WorkerThreads;\n  try {\n    WorkerThreads = require('worker_threads');\n  } catch(error) {\n    if (typeof error === 'object' && error !== null && error.code === 'MODULE_NOT_FOUND') {\n      // no worker_threads, fallback to sub-process based workers\n    } else {\n      throw error;\n    }\n  }\n\n  if (WorkerThreads &&\n    /* if there is a parentPort, we are in a WorkerThread */\n    WorkerThreads.parentPort !== null) {\n    var parentPort  = WorkerThreads.parentPort;\n    worker.send = parentPort.postMessage.bind(parentPort);\n    worker.on = parentPort.on.bind(parentPort);\n    worker.exit = process.exit.bind(process);\n  } else {\n    worker.on = process.on.bind(process);\n    // ignore transfer argument since it is not supported by process\n    worker.send = function (message) {\n      process.send(message);\n    };\n    // register disconnect handler only for subprocess worker to exit when parent is killed unexpectedly\n    worker.on('disconnect', function () {\n      process.exit(1);\n    });\n    worker.exit = process.exit.bind(process);\n  }\n}\nelse {\n  throw new Error('Script must be executed as a worker');\n}\n\nfunction convertError(error) {\n  return Object.getOwnPropertyNames(error).reduce(function(product, name) {\n    return Object.defineProperty(product, name, {\n\tvalue: error[name],\n\tenumerable: true\n    });\n  }, {});\n}\n\n/**\n * Test whether a value is a Promise via duck typing.\n * @param {*} value\n * @returns {boolean} Returns true when given value is an object\n *                    having functions `then` and `catch`.\n */\nfunction isPromise(value) {\n  return value && (typeof value.then === 'function') && (typeof value.catch === 'function');\n}\n\n// functions available externally\nworker.methods = {};\n\n/**\n * Execute a function with provided arguments\n * @param {String} fn     Stringified function\n * @param {Array} [args]  Function arguments\n * @returns {*}\n */\nworker.methods.run = function run(fn, args) {\n  var f = new Function('return (' + fn + ').apply(null, arguments);');\n  return f.apply(f, args);\n};\n\n/**\n * Get a list with methods available on this worker\n * @return {String[]} methods\n */\nworker.methods.methods = function methods() {\n  return Object.keys(worker.methods);\n};\n\n/**\n * Custom handler for when the worker is terminated.\n */\nworker.terminationHandler = undefined;\n\n/**\n * Cleanup and exit the worker.\n * @param {Number} code \n * @returns \n */\nworker.cleanupAndExit = function(code) {\n  var _exit = function() {\n    worker.exit(code);\n  }\n\n  if(!worker.terminationHandler) {\n    return _exit();\n  }\n\n  var result = worker.terminationHandler(code);\n  if (isPromise(result)) {\n    result.then(_exit, _exit);\n  } else {\n    _exit();\n  }\n}\n\nvar currentRequestId = null;\n\nworker.on('message', function (request) {\n  if (request === TERMINATE_METHOD_ID) {\n    return worker.cleanupAndExit(0);\n  }\n  try {\n    var method = worker.methods[request.method];\n\n    if (method) {\n      currentRequestId = request.id;\n      \n      // execute the function\n      var result = method.apply(method, request.params);\n\n      if (isPromise(result)) {\n        // promise returned, resolve this and then return\n        result\n            .then(function (result) {\n              if (result instanceof Transfer) {\n                worker.send({\n                  id: request.id,\n                  result: result.message,\n                  error: null\n                }, result.transfer);\n              } else {\n                worker.send({\n                  id: request.id,\n                  result: result,\n                  error: null\n                });\n              }\n              currentRequestId = null;\n            })\n            .catch(function (err) {\n              worker.send({\n                id: request.id,\n                result: null,\n                error: convertError(err)\n              });\n              currentRequestId = null;\n            });\n      }\n      else {\n        // immediate result\n        if (result instanceof Transfer) {\n          worker.send({\n            id: request.id,\n            result: result.message,\n            error: null\n          }, result.transfer);\n        } else {\n          worker.send({\n            id: request.id,\n            result: result,\n            error: null\n          });\n        }\n\n        currentRequestId = null;\n      }\n    }\n    else {\n      throw new Error('Unknown method \"' + request.method + '\"');\n    }\n  }\n  catch (err) {\n    worker.send({\n      id: request.id,\n      result: null,\n      error: convertError(err)\n    });\n  }\n});\n\n/**\n * Register methods to the worker\n * @param {Object} [methods]\n * @param {import('./types.js').WorkerRegisterOptions} [options]\n */\nworker.register = function (methods, options) {\n\n  if (methods) {\n    for (var name in methods) {\n      if (methods.hasOwnProperty(name)) {\n        worker.methods[name] = methods[name];\n      }\n    }\n  }\n\n  if (options) {\n    worker.terminationHandler = options.onTerminate;\n  }\n\n  worker.send('ready');\n};\n\nworker.emit = function (payload) {\n  if (currentRequestId) {\n    if (payload instanceof Transfer) {\n      worker.send({\n        id: currentRequestId,\n        isEvent: true,\n        payload: payload.message\n      }, payload.transfer);\n      return;\n    }\n\n    worker.send({\n      id: currentRequestId,\n      isEvent: true,\n      payload\n    });\n  }\n};\n\nif (typeof exports !== 'undefined') {\n  exports.add = worker.register;\n  exports.emit = worker.emit;\n}\n"],"names":["Transfer","message","transfer","require$$0","TERMINATE_METHOD_ID","worker","exit","self","postMessage","addEventListener","on","event","callback","data","send","process","WorkerThreads","require","error","code","parentPort","bind","Error","convertError","Object","getOwnPropertyNames","reduce","product","name","defineProperty","value","enumerable","isPromise","then","catch","methods","run","fn","args","f","Function","apply","keys","terminationHandler","undefined","cleanupAndExit","_exit","result","currentRequestId","request","method","id","params","err","register","options","hasOwnProperty","onTerminate","emit","payload","isEvent","exports","add"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAMA,SAASA,QAAQA,CAACC,OAAO,EAAEC,QAAQ,EAAE;GACnC,IAAI,CAACD,OAAO,GAAGA,OAAO,CAAA;GACtB,IAAI,CAACC,QAAQ,GAAGA,QAAQ,CAAA;CAC1B,CAAA;CAEA,IAAAA,QAAc,GAAGF,QAAQ;;;;;;;GCPzB,IAAIA,QAAQ,GAAGG,QAAqB,CAAA;;CAEpC;CACA;CACA;CACA;GACA,IAAIC,mBAAmB,GAAG,0BAA0B,CAAA;;CAEpD;;CAEA;CACA;CACA,EAAA,IAAIC,MAAM,GAAG;CACXC,IAAAA,IAAI,EAAE,YAAW,EAAE;IACpB,CAAA;CACD,EAAA,IAAI,OAAOC,IAAI,KAAK,WAAW,IAAI,OAAOC,WAAW,KAAK,UAAU,IAAI,OAAOC,gBAAgB,KAAK,UAAU,EAAE;CAChH;CACEJ,IAAAA,MAAM,CAACK,EAAE,GAAG,UAAUC,KAAK,EAAEC,QAAQ,EAAE;CACrCH,MAAAA,gBAAgB,CAACE,KAAK,EAAE,UAAUV,OAAO,EAAE;CACzCW,QAAAA,QAAQ,CAACX,OAAO,CAACY,IAAI,CAAC,CAAA;CAC5B,OAAK,CAAC,CAAA;MACH,CAAA;CACDR,IAAAA,MAAM,CAACS,IAAI,GAAG,UAAUb,OAAO,EAAE;OAC/BO,WAAW,CAACP,OAAO,CAAC,CAAA;MACrB,CAAA;CACH,GAAC,MACI,IAAI,OAAOc,OAAO,KAAK,WAAW,EAAE;CACzC;;CAEE,IAAA,IAAIC,aAAa,CAAA;KACjB,IAAI;CACFA,MAAAA,aAAa,GAAGC,OAAQ,CAAA,gBAAgB,CAAC,CAAA;MAC1C,CAAC,OAAMC,KAAK,EAAE;CACb,MAAA,IAAI,OAAOA,KAAK,KAAK,QAAQ,IAAIA,KAAK,KAAK,IAAI,IAAIA,KAAK,CAACC,IAAI,KAAK,kBAAkB,EAAE,CAErF,MAAM;CACL,QAAA,MAAMD,KAAK,CAAA;CACZ,OAAA;CACF,KAAA;CAED,IAAA,IAAIF,aAAa;CAEfA,IAAAA,aAAa,CAACI,UAAU,KAAK,IAAI,EAAE;CACnC,MAAA,IAAIA,UAAU,GAAIJ,aAAa,CAACI,UAAU,CAAA;OAC1Cf,MAAM,CAACS,IAAI,GAAGM,UAAU,CAACZ,WAAW,CAACa,IAAI,CAACD,UAAU,CAAC,CAAA;OACrDf,MAAM,CAACK,EAAE,GAAGU,UAAU,CAACV,EAAE,CAACW,IAAI,CAACD,UAAU,CAAC,CAAA;OAC1Cf,MAAM,CAACC,IAAI,GAAGS,OAAO,CAACT,IAAI,CAACe,IAAI,CAACN,OAAO,CAAC,CAAA;CAC5C,KAAG,MAAM;OACLV,MAAM,CAACK,EAAE,GAAGK,OAAO,CAACL,EAAE,CAACW,IAAI,CAACN,OAAO,CAAC,CAAA;CACxC;CACIV,MAAAA,MAAM,CAACS,IAAI,GAAG,UAAUb,OAAO,EAAE;CAC/Bc,QAAAA,OAAO,CAACD,IAAI,CAACb,OAAO,CAAC,CAAA;QACtB,CAAA;CACL;CACII,MAAAA,MAAM,CAACK,EAAE,CAAC,YAAY,EAAE,YAAY;CAClCK,QAAAA,OAAO,CAACT,IAAI,CAAC,CAAC,CAAC,CAAA;CACrB,OAAK,CAAC,CAAA;OACFD,MAAM,CAACC,IAAI,GAAGS,OAAO,CAACT,IAAI,CAACe,IAAI,CAACN,OAAO,CAAC,CAAA;CACzC,KAAA;CACH,GAAC,MACI;CACH,IAAA,MAAM,IAAIO,KAAK,CAAC,qCAAqC,CAAC,CAAA;CACxD,GAAA;GAEA,SAASC,YAAYA,CAACL,KAAK,EAAE;CAC3B,IAAA,OAAOM,MAAM,CAACC,mBAAmB,CAACP,KAAK,CAAC,CAACQ,MAAM,CAAC,UAASC,OAAO,EAAEC,IAAI,EAAE;CACtE,MAAA,OAAOJ,MAAM,CAACK,cAAc,CAACF,OAAO,EAAEC,IAAI,EAAE;CAC/CE,QAAAA,KAAK,EAAEZ,KAAK,CAACU,IAAI,CAAC;CAClBG,QAAAA,UAAU,EAAE,IAAA;CACb,OAAK,CAAC,CAAA;MACH,EAAE,EAAE,CAAC,CAAA;CACR,GAAA;;CAEA;CACA;CACA;CACA;CACA;CACA;GACA,SAASC,SAASA,CAACF,KAAK,EAAE;CACxB,IAAA,OAAOA,KAAK,IAAK,OAAOA,KAAK,CAACG,IAAI,KAAK,UAAW,IAAK,OAAOH,KAAK,CAACI,KAAK,KAAK,UAAW,CAAA;CAC3F,GAAA;;CAEA;CACA7B,EAAAA,MAAM,CAAC8B,OAAO,GAAG,EAAE,CAAA;;CAEnB;CACA;CACA;CACA;CACA;CACA;GACA9B,MAAM,CAAC8B,OAAO,CAACC,GAAG,GAAG,SAASA,GAAGA,CAACC,EAAE,EAAEC,IAAI,EAAE;KAC1C,IAAIC,CAAC,GAAG,IAAIC,QAAQ,CAAC,UAAU,GAAGH,EAAE,GAAG,2BAA2B,CAAC,CAAA;CACnE,IAAA,OAAOE,CAAC,CAACE,KAAK,CAACF,CAAC,EAAED,IAAI,CAAC,CAAA;IACxB,CAAA;;CAED;CACA;CACA;CACA;GACAjC,MAAM,CAAC8B,OAAO,CAACA,OAAO,GAAG,SAASA,OAAOA,GAAG;CAC1C,IAAA,OAAOX,MAAM,CAACkB,IAAI,CAACrC,MAAM,CAAC8B,OAAO,CAAC,CAAA;IACnC,CAAA;;CAED;CACA;CACA;GACA9B,MAAM,CAACsC,kBAAkB,GAAGC,SAAS,CAAA;;CAErC;CACA;CACA;CACA;CACA;CACAvC,EAAAA,MAAM,CAACwC,cAAc,GAAG,UAAS1B,IAAI,EAAE;CACrC,IAAA,IAAI2B,KAAK,GAAG,YAAW;CACrBzC,MAAAA,MAAM,CAACC,IAAI,CAACa,IAAI,CAAC,CAAA;MAClB,CAAA;CAED,IAAA,IAAG,CAACd,MAAM,CAACsC,kBAAkB,EAAE;OAC7B,OAAOG,KAAK,EAAE,CAAA;CACf,KAAA;CAED,IAAA,IAAIC,MAAM,GAAG1C,MAAM,CAACsC,kBAAkB,CAACxB,IAAI,CAAC,CAAA;CAC5C,IAAA,IAAIa,SAAS,CAACe,MAAM,CAAC,EAAE;CACrBA,MAAAA,MAAM,CAACd,IAAI,CAACa,KAAK,EAAEA,KAAK,CAAC,CAAA;CAC7B,KAAG,MAAM;CACLA,MAAAA,KAAK,EAAE,CAAA;CACR,KAAA;IACF,CAAA;GAED,IAAIE,gBAAgB,GAAG,IAAI,CAAA;CAE3B3C,EAAAA,MAAM,CAACK,EAAE,CAAC,SAAS,EAAE,UAAUuC,OAAO,EAAE;KACtC,IAAIA,OAAO,KAAK7C,mBAAmB,EAAE;CACnC,MAAA,OAAOC,MAAM,CAACwC,cAAc,CAAC,CAAC,CAAC,CAAA;CAChC,KAAA;KACD,IAAI;OACF,IAAIK,MAAM,GAAG7C,MAAM,CAAC8B,OAAO,CAACc,OAAO,CAACC,MAAM,CAAC,CAAA;CAE3C,MAAA,IAAIA,MAAM,EAAE;SACVF,gBAAgB,GAAGC,OAAO,CAACE,EAAE,CAAA;;CAEnC;SACM,IAAIJ,MAAM,GAAGG,MAAM,CAACT,KAAK,CAACS,MAAM,EAAED,OAAO,CAACG,MAAM,CAAC,CAAA;CAEjD,QAAA,IAAIpB,SAAS,CAACe,MAAM,CAAC,EAAE;CAC7B;CACQA,UAAAA,MAAM,CACDd,IAAI,CAAC,UAAUc,MAAM,EAAE;aACtB,IAAIA,MAAM,YAAY/C,QAAQ,EAAE;eAC9BK,MAAM,CAACS,IAAI,CAAC;iBACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;iBACdJ,MAAM,EAAEA,MAAM,CAAC9C,OAAO;CACtBiB,gBAAAA,KAAK,EAAE,IAAA;CACzB,eAAiB,EAAE6B,MAAM,CAAC7C,QAAQ,CAAC,CAAA;CACnC,aAAe,MAAM;eACLG,MAAM,CAACS,IAAI,CAAC;iBACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;CACdJ,gBAAAA,MAAM,EAAEA,MAAM;CACd7B,gBAAAA,KAAK,EAAE,IAAA;CACzB,eAAiB,CAAC,CAAA;CACH,aAAA;CACD8B,YAAAA,gBAAgB,GAAG,IAAI,CAAA;CACrC,WAAa,CAAC,CACDd,KAAK,CAAC,UAAUmB,GAAG,EAAE;aACpBhD,MAAM,CAACS,IAAI,CAAC;eACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;CACdJ,cAAAA,MAAM,EAAE,IAAI;eACZ7B,KAAK,EAAEK,YAAY,CAAC8B,GAAG,CAAA;CACvC,aAAe,CAAC,CAAA;CACFL,YAAAA,gBAAgB,GAAG,IAAI,CAAA;CACrC,WAAa,CAAC,CAAA;CACP,SAAA,MACI;CACX;WACQ,IAAID,MAAM,YAAY/C,QAAQ,EAAE;aAC9BK,MAAM,CAACS,IAAI,CAAC;eACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;eACdJ,MAAM,EAAEA,MAAM,CAAC9C,OAAO;CACtBiB,cAAAA,KAAK,EAAE,IAAA;CACnB,aAAW,EAAE6B,MAAM,CAAC7C,QAAQ,CAAC,CAAA;CAC7B,WAAS,MAAM;aACLG,MAAM,CAACS,IAAI,CAAC;eACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;CACdJ,cAAAA,MAAM,EAAEA,MAAM;CACd7B,cAAAA,KAAK,EAAE,IAAA;CACnB,aAAW,CAAC,CAAA;CACH,WAAA;CAED8B,UAAAA,gBAAgB,GAAG,IAAI,CAAA;CACxB,SAAA;CACF,OAAA,MACI;SACH,MAAM,IAAI1B,KAAK,CAAC,kBAAkB,GAAG2B,OAAO,CAACC,MAAM,GAAG,GAAG,CAAC,CAAA;CAC3D,OAAA;MACF,CACD,OAAOG,GAAG,EAAE;OACVhD,MAAM,CAACS,IAAI,CAAC;SACVqC,EAAE,EAAEF,OAAO,CAACE,EAAE;CACdJ,QAAAA,MAAM,EAAE,IAAI;SACZ7B,KAAK,EAAEK,YAAY,CAAC8B,GAAG,CAAA;CAC7B,OAAK,CAAC,CAAA;CACH,KAAA;CACH,GAAC,CAAC,CAAA;;CAEF;CACA;CACA;CACA;CACA;CACAhD,EAAAA,MAAM,CAACiD,QAAQ,GAAG,UAAUnB,OAAO,EAAEoB,OAAO,EAAE;CAE5C,IAAA,IAAIpB,OAAO,EAAE;CACX,MAAA,KAAK,IAAIP,IAAI,IAAIO,OAAO,EAAE;CACxB,QAAA,IAAIA,OAAO,CAACqB,cAAc,CAAC5B,IAAI,CAAC,EAAE;WAChCvB,MAAM,CAAC8B,OAAO,CAACP,IAAI,CAAC,GAAGO,OAAO,CAACP,IAAI,CAAC,CAAA;CACrC,SAAA;CACF,OAAA;CACF,KAAA;CAED,IAAA,IAAI2B,OAAO,EAAE;CACXlD,MAAAA,MAAM,CAACsC,kBAAkB,GAAGY,OAAO,CAACE,WAAW,CAAA;CAChD,KAAA;CAEDpD,IAAAA,MAAM,CAACS,IAAI,CAAC,OAAO,CAAC,CAAA;IACrB,CAAA;CAEDT,EAAAA,MAAM,CAACqD,IAAI,GAAG,UAAUC,OAAO,EAAE;CAC/B,IAAA,IAAIX,gBAAgB,EAAE;OACpB,IAAIW,OAAO,YAAY3D,QAAQ,EAAE;SAC/BK,MAAM,CAACS,IAAI,CAAC;CACVqC,UAAAA,EAAE,EAAEH,gBAAgB;CACpBY,UAAAA,OAAO,EAAE,IAAI;WACbD,OAAO,EAAEA,OAAO,CAAC1D,OAAAA;CACzB,SAAO,EAAE0D,OAAO,CAACzD,QAAQ,CAAC,CAAA;CACpB,QAAA,OAAA;CACD,OAAA;OAEDG,MAAM,CAACS,IAAI,CAAC;CACVqC,QAAAA,EAAE,EAAEH,gBAAgB;CACpBY,QAAAA,OAAO,EAAE,IAAI;CACbD,QAAAA,OAAAA;CACN,OAAK,CAAC,CAAA;CACH,KAAA;IACF,CAAA;GAEmC;CAClCE,IAAAA,OAAc,CAAAC,GAAA,GAAAzD,MAAM,CAACiD,QAAQ,CAAA;CAC7BO,IAAAA,OAAe,CAAAH,IAAA,GAAArD,MAAM,CAACqD,IAAI,CAAA;CAC5B,GAAA;;;;;;;;;;"}